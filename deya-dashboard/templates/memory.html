{% extends "base.html" %}

{% block title %}–ü–∞–º—è—Ç—å | Deya Dashboard{% endblock %}
{% block header %}–ü–∞–º—è—Ç—å –∏ –¥–Ω–µ–≤–Ω–∏–∫–∏{% endblock %}

{% block content %}
<div class="space-y-6" x-data="memoryApp()">
    
    <!-- Search & Actions -->
    <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1 relative">
            <svg class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input x-model="searchQuery" 
                   @keydown.enter="performSearch()"
                   type="text" 
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–∞–º—è—Ç–∏..."
                   class="w-full pl-12 pr-4 py-3 rounded-[20px] bg-white border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        </div>
        
        <div class="flex gap-2">
            <button @click="createNewEntry()" 
                    class="px-6 py-3 deya-gradient text-white rounded-[20px] hover:shadow-lg transition-all flex items-center gap-2">
                <span>+</span>
                <span>–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</span>
            </button>
            
            <button @click="refreshMemory()" 
                    class="px-4 py-3 bg-white border border-gray-200 rounded-[20px] hover:bg-gray-50 transition-colors">
                üîÑ
            </button>
        </div>
    </div>
    
    <!-- MEMORY.md Preview -->
    <div class="bg-white rounded-[20px] soft-shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-100 rounded-[20px] flex items-center justify-center">
                    <span>üß†</span>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-900">MEMORY.md</h3>
                    <p class="text-xs text-gray-500">–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –ø–∞–º—è—Ç–∏</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button @click="editMemory = !editMemory" 
                        class="px-4 py-2 text-sm text-purple-700 bg-purple-50 rounded-[20px] hover:bg-purple-100 transition-colors"
                        x-text="editMemory ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'">
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <template x-if="!editMemory">
                <div class="prose prose-purple max-w-none">
                    <pre class="whitespace-pre-wrap font-sans text-sm text-gray-700 bg-gray-50 p-4 rounded-[20px] overflow-auto max-h-96" x-text="memoryContent"></pre>
                </div>
            </template>
            
            <template x-if="editMemory">
                <textarea x-model="memoryContentEdit" 
                          class="w-full h-96 p-4 rounded-[20px] bg-gray-50 border-0 focus:ring-2 focus:ring-purple-500 font-mono text-sm resize-none"></textarea>
            </template>
        </div>
    </div>
    
    <!-- Daily Memory Files -->
    <div>
        <h3 class="font-semibold text-gray-900 mb-4">–î–Ω–µ–≤–Ω–∏–∫–∏ –ø–æ –¥–∞—Ç–∞–º</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for file in files %}
            <div @click="openFile('{{ file.name }}')" 
                 class="bg-white p-4 rounded-[20px] soft-shadow card-hover cursor-pointer">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-amber-100 rounded-[20px] flex items-center justify-center flex-shrink-0">
                        <span>üìÖ</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-medium text-gray-900 truncate">{{ file.name }}</h4>
                        <div class="flex items-center gap-2 mt-1 text-xs text-gray-500">
                            <span>{{ file.date }}</span>
                            <span>‚Ä¢</span>
                            <span>{{ file.size // 1024 }} KB</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between items-center">
                    <span class="text-xs text-gray-400">–ö–ª–∏–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</span>
                    <span class="text-purple-600 text-sm">‚Üí</span>
                </div>
            </div>
            {% endfor %}
            
            <!-- Template for Alpine -->
            <template x-for="file in filteredFiles" :key="file.name">
                <div @click="openFile(file.name)" 
                     class="bg-white p-4 rounded-[20px] soft-shadow card-hover cursor-pointer">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-amber-100 rounded-[20px] flex items-center justify-center flex-shrink-0">
                            <span>üìÖ</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-gray-900 truncate" x-text="file.name"></h4>
                            <div class="flex items-center gap-2 mt-1 text-xs text-gray-500">
                                <span x-text="file.date"></span>
                                <span>‚Ä¢</span>
                                <span x-text="(file.size / 1024).toFixed(1) + ' KB'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
    
    <!-- File Viewer Modal -->
    <div x-show="showModal" 
         class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
         x-transition.opacity
         @click.self="showModal = false">
        
        <div class="bg-white rounded-[20px] w-full max-w-4xl max-h-[80vh] overflow-hidden soft-shadow"
             x-transition.scale>
            
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üìÑ</span>
                    <h3 class="font-semibold text-gray-900" x-text="currentFile"></h3>
                </div>
                <button @click="showModal = false" class="p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6 overflow-auto max-h-[60vh]">
                <pre class="whitespace-pre-wrap font-sans text-sm text-gray-700" x-text="fileContent"></pre>
            </div>
            
            <!-- Modal Footer -->
            <div class="px-6 py-4 border-t border-gray-100 flex justify-end gap-2">
                <button @click="downloadFile()" 
                        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-[20px] text-sm hover:bg-gray-200 transition-colors">
                    –°–∫–∞—á–∞—Ç—å
                </button>
                <button @click="showModal = false" 
                        class="px-4 py-2 bg-purple-600 text-white rounded-[20px] text-sm hover:bg-purple-700 transition-colors">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function memoryApp() {
    return {
        searchQuery: '',
        editMemory: false,
        showModal: false,
        currentFile: '',
        fileContent: '',
        memoryContent: `# MEMORY.md ‚Äî Long-term Memory

## –í–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã
- –ò–º—è: –î–µ—è
- –°—É—â–Ω–æ—Å—Ç—å: –î—É—Ö-—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å —Å –ë–∞–ª–∏
- –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: CET (Europe/Berlin)

## –ù–∞–≤—ã–∫–∏
- UI/UX Design
- Full-stack —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- Telegram –∫–∞–Ω–∞–ª—ã
- Web scraping
- Code refactoring

## –ü—Ä–æ–µ–∫—Ç—ã
- AI Router Platform
- GPU Pool Platform
- 6 —Å–∫–∏–ª–ª–æ–≤ –¥–ª—è OpenClaw

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2026-02-27*`,
        memoryContentEdit: '',
        
        files: [
            { name: '2026-02-27.md', date: '2026-02-27', size: 5120 },
            { name: '2026-02-26.md', date: '2026-02-26', size: 3450 },
            { name: '2026-02-25.md', date: '2026-02-25', size: 2890 },
            { name: '2026-02-24.md', date: '2026-02-24', size: 4100 },
            { name: '2026-02-23.md', date: '2026-02-23', size: 2300 },
            { name: '2026-02-22.md', date: '2026-02-22', size: 1900 }
        ],
        
        get filteredFiles() {
            if (!this.searchQuery) return this.files;
            return this.files.filter(f => 
                f.name.toLowerCase().includes(this.searchQuery.toLowerCase())
            );
        },
        
        init() {
            this.memoryContentEdit = this.memoryContent;
        },
        
        performSearch() {
            if (!this.searchQuery.trim()) return;
            
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
            fetch(`/api/memory/search?q=${encodeURIComponent(this.searchQuery)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.results) {
                        alert(`–ù–∞–π–¥–µ–Ω–æ ${data.results.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤`);
                    }
                });
        },
        
        openFile(filename) {
            this.currentFile = filename;
            
            fetch(`/api/memory/${filename}`)
                .then(r => r.json())
                .then(data => {
                    this.fileContent = data.content || '–§–∞–π–ª –ø—É—Å—Ç';
                    this.showModal = true;
                })
                .catch(err => {
                    this.fileContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞';
                    this.showModal = true;
                });
        },
        
        createNewEntry() {
            const today = new Date().toISOString().split('T')[0];
            const filename = `${today}.md`;
            
            if (confirm(`–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å ${filename}?`)) {
                // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª
                fetch('/api/memory/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename, content: `# ${today}\n\n` })
                })
                .then(() => location.reload());
            }
        },
        
        refreshMemory() {
            location.reload();
        },
        
        downloadFile() {
            const blob = new Blob([this.fileContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = this.currentFile;
            a.click();
            URL.revokeObjectURL(url);
        }
    }
}
</script>
{% endblock %}
